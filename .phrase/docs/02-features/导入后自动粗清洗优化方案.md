# å¯¼å…¥åè‡ªåŠ¨ç²—æ¸…æ´—åŠŸèƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ å½“å‰å®ç°æ¦‚è¿°

### å¯¼å…¥æ—¶çš„åŸºç¡€æ¸…æ´—ï¼ˆ`fileImportUtils.ts`ï¼‰
å½“å‰åœ¨æ•°æ®å¯¼å…¥æ—¶åªè¿›è¡ŒåŸºç¡€çš„æ ¼å¼æ¸…æ´—ï¼š
- âœ… å»é™¤å…³é”®è¯é¦–å°¾ç©ºæ ¼ (`term.trim()`)
- âœ… æ•°å­—å­—æ®µæ¸…æ´—ï¼ˆ"-"ã€"æœªæ”¶å½•"è½¬ä¸º 0ï¼‰
- âœ… è‡ªåŠ¨è®¡ç®—æ€»æœç´¢é‡ï¼ˆPC + ç§»åŠ¨ï¼‰
- âœ… è¿‡æ»¤ç©ºå€¼ï¼ˆ`if (!term) return null`ï¼‰

### å¯¼å…¥åçš„è‡ªåŠ¨ç²—æ¸…æ´—ï¼ˆ`StepRules.tsx`ï¼‰
ç›®å‰é€šè¿‡ `handleAutoClean()` å‡½æ•°è°ƒç”¨ä¸‰ä¸ªæ•°æ®åº“ RPC å‡½æ•°ï¼š
1. `clean_rule_volume` - æµé‡è¿‡æ»¤ï¼ˆè¿‡æ»¤ä½æµé‡å…³é”®è¯ï¼‰
2. `clean_rule_digits` - æ•°å­—è¿‡æ»¤ï¼ˆè¿‡æ»¤çº¯æ•°å­—å…³é”®è¯ï¼‰
3. `clean_rule_long` - é•¿åº¦è¿‡æ»¤ï¼ˆè¿‡æ»¤è¿‡é•¿å…³é”®è¯ï¼‰

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

æå‡è‡ªåŠ¨ç²—æ¸…æ´—çš„**å‡†ç¡®æ€§**ã€**æ•ˆç‡**å’Œ**å¯é…ç½®æ€§**ï¼Œåœ¨å¯¼å…¥æ•°æ®åç«‹å³è¿‡æ»¤æ‰æ˜æ˜¾æ— æ•ˆçš„å…³é”®è¯ï¼Œå‡å°‘åç»­äººå·¥ç­›é€‰çš„å·¥ä½œé‡ã€‚

---

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¯¼å…¥æ—¶å¢å¼ºçš„æ ¼å¼æ¸…æ´— âœ¨

#### 1.1 å…³é”®è¯æ–‡æœ¬è§„èŒƒåŒ–
**é—®é¢˜**ï¼šå¯¼å…¥çš„æ•°æ®å¯èƒ½åŒ…å«å„ç§æ ¼å¼é—®é¢˜
- å¤šä½™çš„ç©ºæ ¼ã€æ¢è¡Œç¬¦
- ç‰¹æ®Šå­—ç¬¦ï¼ˆå…¨è§’/åŠè§’æ··ç”¨ï¼‰
- é‡å¤çš„å…³é”®è¯

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// src/lib/fileImportUtils.ts
function normalizeKeyword(term: string): string | null {
  if (!term) return null
  
  // 1. å»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬æ¢è¡Œã€åˆ¶è¡¨ç¬¦ç­‰ï¼‰
  term = term.trim().replace(/[\r\n\t]/g, '')
  
  // 2. è§„èŒƒåŒ–ç©ºæ ¼ï¼ˆå¤šä¸ªç©ºæ ¼åˆå¹¶ä¸ºä¸€ä¸ªï¼‰
  term = term.replace(/\s+/g, ' ')
  
  // 3. å…¨è§’è½¬åŠè§’ï¼ˆä¸­æ–‡æ ‡ç‚¹é™¤å¤–ï¼‰
  term = term.replace(/[ï¼ï¼Ÿã€‚ï¼Œã€ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘ã€Šã€‹]/g, (char) => {
    const map: Record<string, string> = {
      'ï¼': '!', 'ï¼Ÿ': '?', 'ã€‚': '.', 'ï¼Œ': ',',
      'ï¼›': ';', 'ï¼š': ':', '""': '"', "''": "'",
      'ï¼ˆ': '(', 'ï¼‰': ')', 'ã€': '[', 'ã€‘': ']',
      'ã€Š': '<', 'ã€‹': '>'
    }
    return map[char] || char
  })
  
  // 4. è¿‡æ»¤ç©ºç™½å…³é”®è¯
  if (!term || term.length === 0) return null
  
  // 5. é•¿åº¦æ£€æŸ¥ï¼ˆè¿‡çŸ­æˆ–è¿‡é•¿éƒ½è¿‡æ»¤ï¼‰
  if (term.length < 2) return null  // å¤ªçŸ­æ— æ„ä¹‰
  if (term.length > 50) return null  // å¤ªé•¿å¯èƒ½æ˜¯é”™è¯¯æ•°æ®
  
  return term
}
```

#### 1.2 å»é‡å¤„ç†
**é—®é¢˜**ï¼šåŒä¸€å…³é”®è¯å¯èƒ½é‡å¤å¯¼å…¥

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨å¯¼å…¥æ—¶è®°å½•å·²å¯¼å…¥çš„å…³é”®è¯ï¼ˆä½¿ç”¨Setï¼‰
const importedTerms = new Set<string>()

const dbRows = batch.map(row => {
  const term = normalizeKeyword(getVal('å…³é”®è¯'))
  if (!term) return null
  
  // æ£€æŸ¥æ˜¯å¦é‡å¤ï¼ˆåœ¨æœ¬æ¬¡å¯¼å…¥ä¸­ï¼‰
  const termKey = `${currentProjectId}_${term}`
  if (importedTerms.has(termKey)) {
    return null  // è·³è¿‡é‡å¤
  }
  importedTerms.add(termKey)
  
  return {
    project_id: currentProjectId,
    term: term,
    // ... å…¶ä»–å­—æ®µ
  }
}).filter(Boolean)
```

#### 1.3 æ•°æ®è´¨é‡æ£€æŸ¥
**é—®é¢˜**ï¼šæ•°æ®å¯èƒ½åŒ…å«æ— æ•ˆæˆ–å¼‚å¸¸å€¼

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
function validateKeywordData(row: {
  term: string
  pc_volume: number
  mobile_volume: number
  search_volume: number
  competition: number
}): boolean {
  // 1. å…³é”®è¯å¿…é¡»å­˜åœ¨
  if (!row.term || row.term.trim().length === 0) return false
  
  // 2. æœç´¢é‡åˆç†æ€§æ£€æŸ¥
  // å¦‚æœPCå’Œç§»åŠ¨æµé‡éƒ½æ˜¯0ï¼Œä½†æ ‡è®°ä¸º"æœªæ”¶å½•"ï¼Œä¿ç•™ï¼ˆå¯èƒ½æ˜¯æ–°è¯ï¼‰
  // å¦‚æœæœç´¢é‡å¼‚å¸¸å¤§ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰ï¼Œè®°å½•è­¦å‘Šä½†ä¿ç•™
  if (row.search_volume > 1000000) {
    console.warn(`å¼‚å¸¸å¤§çš„æœç´¢é‡: ${row.term} (${row.search_volume})`)
  }
  
  // 3. ç«äº‰åº¦èŒƒå›´æ£€æŸ¥ï¼ˆé€šå¸¸0-100ï¼‰
  if (row.competition < 0 || row.competition > 100) {
    console.warn(`å¼‚å¸¸ç«äº‰åº¦: ${row.term} (${row.competition})`)
    // å¯ä»¥ä¿®æ­£ä¸ºåˆç†èŒƒå›´æˆ–æ ‡è®°
  }
  
  return true
}
```

---

### 2. è‡ªåŠ¨ç²—æ¸…æ´—è§„åˆ™å¢å¼º ğŸ”

#### 2.1 æ›´æ™ºèƒ½çš„æµé‡è¿‡æ»¤
**é—®é¢˜**ï¼šå½“å‰åªè¿‡æ»¤ä½æµé‡ï¼Œæ²¡æœ‰è€ƒè™‘æµé‡åˆ†å¸ƒå’Œä¸šåŠ¡åœºæ™¯

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æ–°å¢ RPC å‡½æ•°ï¼šclean_rule_volume_smart
// æ”¯æŒé…ç½®åŒ–çš„æµé‡é˜ˆå€¼
interface VolumeRuleConfig {
  minVolume: number        // æœ€å°æµé‡é˜ˆå€¼ï¼ˆé»˜è®¤ï¼š10ï¼‰
  maxVolume: number        // æœ€å¤§æµé‡é˜ˆå€¼ï¼ˆå¯é€‰ï¼Œè¿‡æ»¤å¼‚å¸¸é«˜æµé‡ï¼‰
  considerZero: boolean    // æ˜¯å¦ä¿ç•™0æµé‡å…³é”®è¯ï¼ˆå¯èƒ½æ˜¯æ–°è¯ï¼‰
  pcMobileRatio: number    // PC/ç§»åŠ¨æµé‡æ¯”ä¾‹æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
}

// æ”¹è¿›é€»è¾‘ï¼š
// 1. æ”¯æŒå¯é…ç½®çš„æœ€å°æµé‡é˜ˆå€¼ï¼ˆè€Œä¸æ˜¯ç¡¬ç¼–ç ï¼‰
// 2. æ”¯æŒè¿‡æ»¤å¼‚å¸¸é«˜æµé‡ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰
// 3. ä¿ç•™0æµé‡ä½†æ ‡è®°ä¸º"æ–°è¯"çš„å…³é”®è¯ï¼ˆå¯é€‰ï¼‰
// 4. æ£€æŸ¥PC/ç§»åŠ¨æµé‡æ¯”ä¾‹æ˜¯å¦å¼‚å¸¸
```

#### 2.2 æ›´ç²¾ç¡®çš„æ•°å­—è¿‡æ»¤
**é—®é¢˜**ï¼šå½“å‰å¯èƒ½è¯¯åˆ åŒ…å«æ•°å­—ä½†æœ‰æ„ä¹‰çš„å…³é”®è¯ï¼ˆå¦‚"iPhone 14"ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æ”¹è¿› clean_rule_digits é€»è¾‘
function shouldFilterByDigits(term: string): boolean {
  // 1. çº¯æ•°å­—ï¼ˆå¦‚"123"ã€"456"ï¼‰â†’ è¿‡æ»¤
  if (/^\d+$/.test(term)) return true
  
  // 2. æ•°å­—å¼€å¤´æˆ–ç»“å°¾çš„çŸ­è¯ï¼ˆå¦‚"123abc"ã€"abc123"ï¼Œé•¿åº¦<5ï¼‰â†’ å¯èƒ½æ˜¯é”™è¯¯æ•°æ®
  if (/^\d+[^\d]+$/.test(term) || /^[^\d]+\d+$/.test(term)) {
    if (term.length < 5) return true
  }
  
  // 3. å¤šä¸ªè¿ç»­æ•°å­—ï¼ˆå¦‚"abc123456def"ï¼‰â†’ å¯èƒ½æ˜¯é”™è¯¯æ•°æ®
  if (/\d{6,}/.test(term)) return true
  
  // 4. ä¿ç•™åŒ…å«æ•°å­—ä½†åˆç†çš„å…³é”®è¯ï¼ˆå¦‚"iPhone 14"ã€"2024å¹´"ï¼‰
  return false
}
```

#### 2.3 æ›´æ™ºèƒ½çš„é•¿åº¦è¿‡æ»¤
**é—®é¢˜**ï¼šå½“å‰å¯èƒ½è¯¯åˆ åˆç†çš„é•¿å°¾å…³é”®è¯

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æ”¹è¿› clean_rule_long é€»è¾‘
function shouldFilterByLength(term: string): boolean {
  // 1. è¿‡çŸ­ï¼ˆ<2å­—ç¬¦ï¼‰â†’ è¿‡æ»¤ï¼ˆå·²åœ¨å¯¼å…¥æ—¶å¤„ç†ï¼‰
  if (term.length < 2) return true
  
  // 2. è¿‡é•¿ï¼ˆ>30å­—ç¬¦ï¼‰â†’ å¯èƒ½æ˜¯é”™è¯¯æ•°æ®æˆ–æ— æ•ˆé•¿å°¾
  if (term.length > 30) return true
  
  // 3. æ£€æŸ¥æ˜¯å¦åŒ…å«å¤§é‡é‡å¤å­—ç¬¦ï¼ˆå¦‚"aaaaaaaa"ï¼‰
  const maxRepeat = Math.max(...term.split('').map(char => {
    let count = 0
    for (let i = 0; i < term.length; i++) {
      if (term[i] === char) count++
    }
    return count
  }))
  if (maxRepeat > term.length * 0.6) return true  // 60%ä»¥ä¸Šé‡å¤å­—ç¬¦
  
  return false
}
```

#### 2.4 æ–°å¢ï¼šç‰¹æ®Šå­—ç¬¦è¿‡æ»¤è§„åˆ™
**é—®é¢˜**ï¼šå…³é”®è¯å¯èƒ½åŒ…å«æ— æ•ˆçš„ç‰¹æ®Šå­—ç¬¦

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æ–°å¢ RPC å‡½æ•°ï¼šclean_rule_special_chars
function shouldFilterBySpecialChars(term: string): boolean {
  // 1. åŒ…å«è¿‡å¤šç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚"å…³é”®è¯!!!@@@###"ï¼‰
  const specialCharCount = (term.match(/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/g) || []).length
  if (specialCharCount > term.length * 0.3) return true  // 30%ä»¥ä¸Šç‰¹æ®Šå­—ç¬¦
  
  // 2. åŒ…å«æ§åˆ¶å­—ç¬¦ï¼ˆä¸å¯è§å­—ç¬¦ï¼‰
  if (/[\x00-\x1F\x7F-\x9F]/.test(term)) return true
  
  // 3. åŒ…å«URLæˆ–é‚®ç®±ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ•°æ®ï¼‰
  if (/https?:\/\//.test(term) || /@/.test(term)) return true
  
  return false
}
```

#### 2.5 æ–°å¢ï¼šæ— æ„ä¹‰è¯è¿‡æ»¤è§„åˆ™
**é—®é¢˜**ï¼šå…³é”®è¯å¯èƒ½åŒ…å«æ˜æ˜¾çš„æ— æ„ä¹‰è¯æ±‡

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æ–°å¢ RPC å‡½æ•°ï¼šclean_rule_meaningless
const MEANINGLESS_PATTERNS = [
  /^æµ‹è¯•\d*$/,           // æµ‹è¯•ã€æµ‹è¯•1ã€æµ‹è¯•123
  /^ç¤ºä¾‹\d*$/,           // ç¤ºä¾‹ã€ç¤ºä¾‹1
  /^demo\d*$/i,          // demoã€Demo1
  /^temp\d*$/i,          // tempã€Temp1
  /^ä¸´æ—¶\d*$/,           // ä¸´æ—¶ã€ä¸´æ—¶1
  /^æ— æ•ˆ\d*$/,           // æ— æ•ˆã€æ— æ•ˆ1
  /^abc\d*$/i,           // abcã€abc123
  /^123\d*$/,            // 123ã€1234
  /^[a-z]{1,3}\d+$/i,    // a1ã€ab12ã€abc123ï¼ˆçŸ­å­—æ¯+æ•°å­—ï¼‰
]

function shouldFilterByMeaningless(term: string): boolean {
  return MEANINGLESS_PATTERNS.some(pattern => pattern.test(term))
}
```

#### 2.6 æ–°å¢ï¼šé‡å¤å…³é”®è¯æ£€æµ‹
**é—®é¢˜**ï¼šæ•°æ®åº“ä¸­å¯èƒ½å­˜åœ¨é‡å¤çš„å…³é”®è¯ï¼ˆä¸åŒé¡¹ç›®æˆ–ä¸åŒæ‰¹æ¬¡å¯¼å…¥ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æ–°å¢ RPC å‡½æ•°ï¼šclean_rule_duplicates
// åœ¨é¡¹ç›®å†…æ£€æµ‹é‡å¤å…³é”®è¯ï¼Œä¿ç•™æµé‡æœ€é«˜çš„ï¼Œæ ‡è®°å…¶ä»–ä¸ºtrash
// SQLé€»è¾‘ï¼š
/*
UPDATE keywords k1
SET status = 'trash'
WHERE k1.project_id = $1
  AND k1.status = 'pending'
  AND EXISTS (
    SELECT 1 FROM keywords k2
    WHERE k2.project_id = $1
      AND k2.term = k1.term
      AND k2.search_volume > k1.search_volume
      AND k2.id != k1.id
  )
*/
```

---

### 3. æ¸…æ´—è§„åˆ™é…ç½®åŒ– âš™ï¸

#### 3.1 å¯é…ç½®çš„æ¸…æ´—è§„åˆ™
**é—®é¢˜**ï¼šå½“å‰æ¸…æ´—è§„åˆ™æ˜¯ç¡¬ç¼–ç çš„ï¼Œæ— æ³•æ ¹æ®é¡¹ç›®éœ€æ±‚è°ƒæ•´

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨ projects è¡¨ä¸­æ·»åŠ æ¸…æ´—é…ç½®å­—æ®µ
interface CleanConfig {
  volume: {
    enabled: boolean
    minVolume: number
    maxVolume?: number
    keepZeroVolume: boolean  // æ˜¯å¦ä¿ç•™0æµé‡å…³é”®è¯
  }
  digits: {
    enabled: boolean
    strict: boolean  // ä¸¥æ ¼æ¨¡å¼ï¼ˆè¿‡æ»¤æ‰€æœ‰åŒ…å«æ•°å­—çš„ï¼‰vs å®½æ¾æ¨¡å¼ï¼ˆåªè¿‡æ»¤çº¯æ•°å­—ï¼‰
  }
  length: {
    enabled: boolean
    minLength: number
    maxLength: number
  }
  specialChars: {
    enabled: boolean
    maxSpecialCharRatio: number  // æœ€å¤§ç‰¹æ®Šå­—ç¬¦æ¯”ä¾‹ï¼ˆ0-1ï¼‰
  }
  meaningless: {
    enabled: boolean
    customPatterns?: string[]  // è‡ªå®šä¹‰æ— æ„ä¹‰è¯æ¨¡å¼
  }
  duplicates: {
    enabled: boolean
    keepHighestVolume: boolean  // ä¿ç•™æµé‡æœ€é«˜çš„é‡å¤é¡¹
  }
}

// å‰ç«¯ UIï¼šåœ¨é¡¹ç›®è®¾ç½®ä¸­é…ç½®æ¸…æ´—è§„åˆ™
// å¯¼å…¥æ—¶å¯ä»¥å¿«é€Ÿé€‰æ‹©é¢„è®¾é…ç½®ï¼ˆä¸¥æ ¼/æ ‡å‡†/å®½æ¾ï¼‰
```

#### 3.2 æ¸…æ´—è§„åˆ™é¢„è®¾
**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
const CLEAN_PRESETS = {
  strict: {
    volume: { enabled: true, minVolume: 50, keepZeroVolume: false },
    digits: { enabled: true, strict: false },
    length: { enabled: true, minLength: 3, maxLength: 25 },
    specialChars: { enabled: true, maxSpecialCharRatio: 0.1 },
    meaningless: { enabled: true },
    duplicates: { enabled: true, keepHighestVolume: true }
  },
  standard: {
    volume: { enabled: true, minVolume: 10, keepZeroVolume: true },
    digits: { enabled: true, strict: false },
    length: { enabled: true, minLength: 2, maxLength: 30 },
    specialChars: { enabled: true, maxSpecialCharRatio: 0.2 },
    meaningless: { enabled: true },
    duplicates: { enabled: true, keepHighestVolume: true }
  },
  loose: {
    volume: { enabled: true, minVolume: 1, keepZeroVolume: true },
    digits: { enabled: true, strict: true },  // å®½æ¾æ¨¡å¼åè€Œæ›´ä¸¥æ ¼ï¼ˆåªè¿‡æ»¤çº¯æ•°å­—ï¼‰
    length: { enabled: false },
    specialChars: { enabled: false },
    meaningless: { enabled: false },
    duplicates: { enabled: true, keepHighestVolume: true }
  }
}
```

---

### 4. æ¸…æ´—æµç¨‹ä¼˜åŒ– ğŸš€

#### 4.1 å¯¼å…¥æ—¶å³æ—¶æ¸…æ´—
**é—®é¢˜**ï¼šå½“å‰å¯¼å…¥åå†æ‰‹åŠ¨è§¦å‘æ¸…æ´—ï¼Œæ•ˆç‡ä½

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨å¯¼å…¥è¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯æ‰¹æ•°æ®å…ˆè¿›è¡ŒåŸºç¡€æ¸…æ´—å†å…¥åº“
export async function importFileToProject(...) {
  // ... ç°æœ‰ä»£ç  ...
  
  for (let i = 0; i < totalRows; i += BATCH_SIZE) {
    const batch = dataRows.slice(i, i + BATCH_SIZE)
    
    const dbRows = batch.map(row => {
      // 1. åŸºç¡€æ¸…æ´—ï¼ˆè§„èŒƒåŒ–ã€éªŒè¯ï¼‰
      const term = normalizeKeyword(getVal('å…³é”®è¯'))
      if (!term) return null
      
      // 2. åº”ç”¨åŸºç¡€è¿‡æ»¤è§„åˆ™ï¼ˆä¸ä¾èµ–æ•°æ®åº“çš„è§„åˆ™ï¼‰
      if (shouldFilterByLength(term)) return null
      if (shouldFilterByMeaningless(term)) return null
      if (shouldFilterBySpecialChars(term)) return null
      
      // ... å…¶ä»–å¤„ç† ...
    }).filter(Boolean)
    
    // 3. æ‰¹é‡æ’å…¥
    if (dbRows.length > 0) {
      await supabase.from('keywords').insert(dbRows)
    }
  }
  
  // 4. å¯¼å…¥å®Œæˆåï¼Œè‡ªåŠ¨åº”ç”¨æ•°æ®åº“çº§æ¸…æ´—è§„åˆ™
  // ï¼ˆéœ€è¦æ•°æ®åº“æŸ¥è¯¢çš„è§„åˆ™ï¼Œå¦‚æµé‡è¿‡æ»¤ã€é‡å¤æ£€æµ‹ï¼‰
  await applyDatabaseCleanRules(currentProjectId)
}
```

#### 4.2 æ¸…æ´—ç»“æœåé¦ˆ
**é—®é¢˜**ï¼šæ¸…æ´—åç”¨æˆ·ä¸çŸ¥é“æ¸…æ´—äº†å¤šå°‘ã€æ¸…æ´—äº†ä»€ä¹ˆ

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
interface CleanResult {
  totalBefore: number
  totalAfter: number
  removed: number
  removedByRule: {
    volume: number
    digits: number
    length: number
    specialChars: number
    meaningless: number
    duplicates: number
  }
  samples: {
    removed: string[]  // è¢«æ¸…æ´—çš„å…³é”®è¯æ ·ä¾‹ï¼ˆæœ€å¤š10ä¸ªï¼‰
    kept: string[]     // ä¿ç•™çš„å…³é”®è¯æ ·ä¾‹ï¼ˆæœ€å¤š10ä¸ªï¼‰
  }
}

// åœ¨æ¸…æ´—å®Œæˆåæ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š
// UI æ˜¾ç¤ºï¼š
// - æ¸…æ´—å‰åæ•°é‡å¯¹æ¯”
// - å„è§„åˆ™æ¸…æ´—çš„æ•°é‡
// - è¢«æ¸…æ´—çš„å…³é”®è¯æ ·ä¾‹ï¼ˆå¯å±•å¼€æŸ¥çœ‹ï¼‰
// - ä¿ç•™çš„å…³é”®è¯æ ·ä¾‹ï¼ˆéªŒè¯æ¸…æ´—æ•ˆæœï¼‰
```

#### 4.3 æ¸…æ´—æ—¥å¿—è®°å½•
**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// åœ¨ keywords è¡¨ä¸­æ·»åŠ å­—æ®µï¼ˆå¯é€‰ï¼‰ï¼š
// - cleaned_at: timestampï¼ˆæ¸…æ´—æ—¶é—´ï¼‰
// - clean_reason: textï¼ˆæ¸…æ´—åŸå› ï¼Œå¦‚"æµé‡è¿‡ä½"ã€"çº¯æ•°å­—"ç­‰ï¼‰

// æˆ–è€…åˆ›å»ºæ¸…æ´—æ—¥å¿—è¡¨ï¼š
// clean_logs: {
//   id, project_id, keyword_id, term, rule_name, reason, created_at
// }
```

---

### 5. æ€§èƒ½ä¼˜åŒ– âš¡ï¸

#### 5.1 æ‰¹é‡å¤„ç†ä¼˜åŒ–
**é—®é¢˜**ï¼šå½“å‰æ¸…æ´—å¯èƒ½é€æ¡å¤„ç†ï¼Œæ€§èƒ½å·®

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```sql
-- ä¼˜åŒ– RPC å‡½æ•°ï¼Œä½¿ç”¨æ‰¹é‡ UPDATE è€Œä¸æ˜¯é€æ¡æ›´æ–°
-- ç¤ºä¾‹ï¼šclean_rule_volume
CREATE OR REPLACE FUNCTION clean_rule_volume(p_id UUID, min_volume INT DEFAULT 10)
RETURNS TABLE(removed_count INT) AS $$
BEGIN
  UPDATE keywords
  SET status = 'trash'
  WHERE project_id = p_id
    AND status = 'pending'
    AND search_volume < min_volume;
  
  RETURN QUERY SELECT COUNT(*)::INT FROM keywords
    WHERE project_id = p_id
      AND status = 'trash'
      AND updated_at > NOW() - INTERVAL '1 second';
END;
$$ LANGUAGE plpgsql;
```

#### 5.2 ç´¢å¼•ä¼˜åŒ–
**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```sql
-- ä¸ºæ¸…æ´—è§„åˆ™å¸¸ç”¨æŸ¥è¯¢æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_keywords_project_status 
  ON keywords(project_id, status);

CREATE INDEX IF NOT EXISTS idx_keywords_project_term 
  ON keywords(project_id, term);

CREATE INDEX IF NOT EXISTS idx_keywords_project_volume 
  ON keywords(project_id, search_volume) 
  WHERE status = 'pending';

-- éƒ¨åˆ†ç´¢å¼•ï¼šåªç´¢å¼•å¾…æ¸…æ´—çš„æ•°æ®
CREATE INDEX IF NOT EXISTS idx_keywords_pending_length 
  ON keywords(project_id, LENGTH(term)) 
  WHERE status = 'pending';
```

---

## ğŸ“Š å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰ğŸ”¥
1. âœ… **å¯¼å…¥æ—¶å…³é”®è¯è§„èŒƒåŒ–** - åŸºç¡€æ¸…æ´—ï¼Œæå‡æ•°æ®è´¨é‡
2. âœ… **å¯¼å…¥æ—¶å»é‡å¤„ç†** - é¿å…é‡å¤æ•°æ®
3. âœ… **æ”¹è¿›æ•°å­—/é•¿åº¦/ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤** - æå‡æ¸…æ´—å‡†ç¡®æ€§
4. âœ… **æ–°å¢æ— æ„ä¹‰è¯è¿‡æ»¤** - è¿‡æ»¤æ˜æ˜¾åƒåœ¾æ•°æ®
5. âœ… **æ¸…æ´—ç»“æœåé¦ˆ** - æå‡ç”¨æˆ·ä½“éªŒ

### ä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸå®æ–½ï¼‰âš ï¸
6. âš ï¸ **æ¸…æ´—è§„åˆ™é…ç½®åŒ–** - å¢åŠ çµæ´»æ€§
7. âš ï¸ **æ–°å¢é‡å¤å…³é”®è¯æ£€æµ‹** - è¿›ä¸€æ­¥ä¼˜åŒ–æ•°æ®è´¨é‡
8. âš ï¸ **å¯¼å…¥æ—¶å³æ—¶æ¸…æ´—** - æå‡æ•ˆç‡
9. âš ï¸ **æ¸…æ´—æ—¥å¿—è®°å½•** - ä¾¿äºè¿½æº¯å’Œè°ƒè¯•

### ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸè§„åˆ’ï¼‰ğŸ“…
10. ğŸ“… **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–** - æå‡æŸ¥è¯¢æ€§èƒ½ï¼ˆå¦‚æœæ•°æ®é‡å¤§ï¼‰
11. ğŸ“… **æ‰¹é‡å¤„ç†ä¼˜åŒ–** - å¦‚æœæ¸…æ´—é€Ÿåº¦æˆä¸ºç“¶é¢ˆ

---

## ğŸ¨ UI æ”¹è¿›å»ºè®®

### å¯¼å…¥æ—¶
- æ˜¾ç¤ºæ¸…æ´—ç»Ÿè®¡ï¼š`å¯¼å…¥ 1000 æ¡ï¼Œè‡ªåŠ¨æ¸…æ´— 150 æ¡æ— æ•ˆæ•°æ®ï¼Œå®é™…å¯¼å…¥ 850 æ¡`
- æ˜¾ç¤ºæ¸…æ´—åŸå› ï¼ˆå¯å±•å¼€æŸ¥çœ‹è¢«æ¸…æ´—çš„å…³é”®è¯ï¼‰

### å¯¼å…¥å
- "è‡ªåŠ¨ç²—æ¸…æ´—"æŒ‰é’®æ”¹ä¸ºå¯é…ç½®çš„ä¸‹æ‹‰èœå•ï¼š
  - å¿«é€Ÿæ¸…æ´—ï¼ˆä½¿ç”¨é»˜è®¤è§„åˆ™ï¼‰
  - æ ‡å‡†æ¸…æ´—ï¼ˆä½¿ç”¨æ ‡å‡†é¢„è®¾ï¼‰
  - ä¸¥æ ¼æ¸…æ´—ï¼ˆä½¿ç”¨ä¸¥æ ¼é¢„è®¾ï¼‰
  - è‡ªå®šä¹‰æ¸…æ´—ï¼ˆæ‰“å¼€é…ç½®é¢æ¿ï¼‰
- æ¸…æ´—å®Œæˆåæ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Šï¼ˆå¼¹çª—æˆ–ä¾§è¾¹æ ï¼‰
- æ”¯æŒ"æ’¤é”€æ¸…æ´—"ï¼ˆå°†æœ€è¿‘ä¸€æ¬¡æ¸…æ´—çš„ trash çŠ¶æ€æ”¹å› pendingï¼‰

---

## ğŸ“ æ•°æ®åº“å˜æ›´

### æ–°å¢å­—æ®µï¼ˆå¯é€‰ï¼‰
```sql
-- projects è¡¨
ALTER TABLE projects ADD COLUMN clean_config JSONB;

-- keywords è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºæ¸…æ´—æ—¥å¿—ï¼‰
ALTER TABLE keywords ADD COLUMN cleaned_at TIMESTAMP;
ALTER TABLE keywords ADD COLUMN clean_reason TEXT;
```

### æ–°å¢ RPC å‡½æ•°
```sql
-- clean_rule_volume_smart: æ”¯æŒé…ç½®çš„æµé‡è¿‡æ»¤
-- clean_rule_special_chars: ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤
-- clean_rule_meaningless: æ— æ„ä¹‰è¯è¿‡æ»¤
-- clean_rule_duplicates: é‡å¤å…³é”®è¯æ£€æµ‹
-- apply_clean_rules: åº”ç”¨æ‰€æœ‰æ¸…æ´—è§„åˆ™ï¼ˆæ‰¹é‡ï¼‰
-- get_clean_result: è·å–æ¸…æ´—ç»“æœç»Ÿè®¡
```

---

## âœ… éªŒæ”¶æ ‡å‡†

1. **å‡†ç¡®æ€§**ï¼šæ¸…æ´—è§„åˆ™å‡†ç¡®ï¼Œä¸ä¼šè¯¯åˆ æœ‰æ•ˆå…³é”®è¯
2. **æ•ˆç‡**ï¼šå¯¼å…¥1000æ¡å…³é”®è¯ï¼Œæ¸…æ´—æ—¶é—´ < 5ç§’
3. **å¯é…ç½®æ€§**ï¼šç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ¸…æ´—è§„åˆ™æˆ–é€‰æ‹©é¢„è®¾
4. **å¯è¿½æº¯æ€§**ï¼šç”¨æˆ·å¯ä»¥çœ‹åˆ°æ¸…æ´—äº†ä»€ä¹ˆã€ä¸ºä»€ä¹ˆæ¸…æ´—
5. **å¯æ¢å¤æ€§**ï¼šæ”¯æŒæ’¤é”€æœ€è¿‘ä¸€æ¬¡æ¸…æ´—æ“ä½œ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é•¿å°¾è¯ç­›é€‰åŠŸèƒ½ä¼˜åŒ–å»ºè®®](./é•¿å°¾è¯ç­›é€‰åŠŸèƒ½ä¼˜åŒ–å»ºè®®.md)
- [é¡¹ç›®è¯´æ˜](../01-project/é¡¹ç›®è¯´æ˜.md)




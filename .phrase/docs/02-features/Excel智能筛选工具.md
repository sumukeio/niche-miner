# Excel 智能筛选工具

## 📋 功能概述

提供一个独立的 Excel 文件智能筛选工具，支持自动识别字段、预览数据、按规则筛选提取关键词，并支持导入到手动筛选页面进行验证标记。

---

## 🎯 核心功能

### 1. 文件解析与字段识别

#### 1.1 自动识别字段名所在行
- **功能**：自动扫描 Excel 文件前 10 行，识别包含字段名的行
- **识别策略**：
  - 查找包含常见字段关键词的行（如"关键词"、"词"、"名称"等）
  - 如果未找到，默认使用第一行作为表头
  - 支持用户手动指定表头行号（可选）

#### 1.2 读取所有字段名
- 从识别出的表头行读取所有列名
- 处理空列、合并单元格等情况
- 显示字段列表供用户选择

---

### 2. 数据预览

#### 2.1 预览表格展示
- **展示内容**：以表格形式展示每列的前 10 条数据
- **展示方式**：
  - 横向滚动支持多列查看
  - 每列显示列名和对应的前 10 条数据
  - 空值显示为"（空）"
- **交互**：
  - 支持调整列宽
  - 支持排序（可选）

---

### 3. 列筛选配置

#### 3.1 选择要处理的列
- 用户可以从字段列表中选择一个或多个列进行处理
- 支持多选（可同时处理多列）

#### 3.2 填写关键词
- 输入框：用户输入关键词
- 示例：
  - 输入："沉香手串"
  - 输入："黄花梨手串价格"

#### 3.3 选择筛选规则
提供三种筛选规则：

1. **包含该关键词**
   - 规则：提取包含该关键词的所有内容
   - 示例：关键词"手串" → 提取所有包含"手串"的文本

2. **以该关键词为后缀**
   - 规则：提取以该关键词结尾的内容
   - 示例：
     - 关键词"手串" → "沉香手串" → 提取"沉香手串"
     - 关键词"手串" → "黄花梨手串价格" → 提取"黄花梨手串"
   - **提取逻辑**：从文本中提取以关键词为后缀的最长匹配片段

3. **以该关键词为前缀**
   - 规则：提取以该关键词开头的内容
   - 示例：关键词"沉香" → "沉香手串价格" → 提取"沉香手串价格"（或根据分隔符提取到第一个分隔符）

---

### 4. 数据筛选与提取

#### 4.1 读取列数据
- 读取选中列的所有数据（跳过表头行）
- 处理空值、重复值

#### 4.2 按规则筛选
根据用户选择的规则进行筛选：

**规则1：包含该关键词**
```typescript
// 伪代码
if (cellValue.includes(keyword)) {
  extractedValue = cellValue  // 提取整个单元格内容
}
```

**规则2：以该关键词为后缀**
```typescript
// 伪代码
if (cellValue.endsWith(keyword)) {
  // 提取以关键词为后缀的最长匹配片段
  // 例如："黄花梨手串价格" + 关键词"手串" → "黄花梨手串"
  extractedValue = extractSuffixMatch(cellValue, keyword)
}
```

**规则3：以该关键词为前缀**
```typescript
// 伪代码
if (cellValue.startsWith(keyword)) {
  // 提取以关键词为前缀的片段（可到第一个分隔符或整个内容）
  extractedValue = extractPrefixMatch(cellValue, keyword)
}
```

#### 4.3 去重处理
- 对提取出的结果进行去重
- 去除空值和纯空格值
- 显示去重前后的数量统计

#### 4.4 结果展示
- 显示筛选结果列表
- 显示统计信息：
  - 原始数据条数
  - 筛选后条数
  - 去重后条数
- 支持导出结果（可选）

---

### 5. 手动筛选页面

#### 5.1 导入功能
- 用户可以选择将筛选结果导入到"手动筛选页面"
- 导入时创建新的筛选任务或追加到现有任务

#### 5.2 验证标记功能
- **标记为"已验证"**：
  - 用户可以对关键词进行标记
  - 标记后状态变为"已验证"
  - 支持批量标记（多选后批量标记）
- **未标记状态**：
  - 默认状态为"未验证"
  - 未标记的关键词保持"未验证"状态

#### 5.3 筛选显示功能
- **筛选选项**：
  - 显示全部
  - 仅显示已验证
  - 仅显示未验证
- **交互**：
  - 使用标签页或下拉菜单切换筛选状态
  - 实时更新列表

#### 5.4 其他功能（可选）
- 搜索关键词
- 排序（按字母顺序、按标记时间等）
- 导出已验证的关键词列表

---

## 🔄 用户流程

### 流程1：文件上传与预览
1. 用户上传 Excel 文件（`.xlsx`, `.xls`）
2. 系统自动识别表头行
3. 显示字段列表和数据预览（每列前 10 条）
4. 用户确认字段识别是否正确（可手动调整）

### 流程2：配置筛选规则
1. 用户选择一个或多个要处理的列
2. 输入关键词
3. 选择筛选规则（包含/后缀/前缀）
4. 点击"开始筛选"按钮

### 流程3：查看筛选结果
1. 系统显示筛选进度
2. 筛选完成后显示结果列表
3. 显示统计信息（原始数、筛选后数、去重后数）
4. 用户可以：
   - 查看详细结果
   - 导出结果（可选）
   - 选择导入到手动筛选页面

### 流程4：手动筛选与验证
1. 用户选择"导入到手动筛选页面"
2. 进入手动筛选页面，显示所有关键词
3. 用户逐个或批量标记关键词为"已验证"
4. 使用筛选功能查看已验证/未验证的关键词
5. 导出最终验证结果（可选）

---

## 🎨 UI 设计建议

### 页面1：文件上传与预览
```
┌─────────────────────────────────────┐
│  Excel 智能筛选工具                  │
├─────────────────────────────────────┤
│  [上传文件] 选择 Excel 文件          │
│                                      │
│  表头识别：第 1 行 ✓                 │
│  [手动指定行号: ___]                 │
│                                      │
│  字段列表：                          │
│  ☑ 关键词                            │
│  ☐ PC日检索量                        │
│  ☐ 移动日检索量                      │
│  ...                                 │
│                                      │
│  数据预览（每列前10条）：            │
│  ┌─────────┬─────────┬─────────┐   │
│  │ 关键词   │ PC检索  │ 移动检索│   │
│  ├─────────┼─────────┼─────────┤   │
│  │ 沉香手串 │ 100     │ 200     │   │
│  │ 黄花梨...│ 50      │ 150     │   │
│  │ ...      │ ...     │ ...     │   │
│  └─────────┴─────────┴─────────┘   │
│                                      │
│  [下一步：配置筛选规则]               │
└─────────────────────────────────────┘
```

### 页面2：筛选配置
```
┌─────────────────────────────────────┐
│  配置筛选规则                        │
├─────────────────────────────────────┤
│  选择要处理的列：                    │
│  ☑ 关键词                            │
│                                      │
│  输入关键词：                        │
│  [________________]                  │
│  示例：手串、沉香手串                │
│                                      │
│  选择筛选规则：                      │
│  ○ 包含该关键词                      │
│  ● 以该关键词为后缀                  │
│  ○ 以该关键词为前缀                  │
│                                      │
│  [开始筛选]                          │
└─────────────────────────────────────┘
```

### 页面3：筛选结果
```
┌─────────────────────────────────────┐
│  筛选结果                            │
├─────────────────────────────────────┤
│  统计信息：                          │
│  原始数据：10,000 条                 │
│  筛选后：1,234 条                    │
│  去重后：856 条                      │
│                                      │
│  结果列表：                          │
│  ┌───────────────────────────────┐  │
│  │ 1. 沉香手串                   │  │
│  │ 2. 黄花梨手串                 │  │
│  │ 3. 小叶紫檀手串               │  │
│  │ ...                           │  │
│  └───────────────────────────────┘  │
│                                      │
│  [导出结果] [导入到手动筛选页面]      │
└─────────────────────────────────────┘
```

### 页面4：手动筛选页面
```
┌─────────────────────────────────────┐
│  手动筛选与验证                      │
├─────────────────────────────────────┤
│  筛选：                              │
│  [全部] [已验证] [未验证]            │
│                                      │
│  搜索：[____________]                │
│                                      │
│  关键词列表：                        │
│  ┌───────────────────────────────┐  │
│  │ ☑ 沉香手串        [已验证] ✓ │  │
│  │ ☐ 黄花梨手串      [未验证]   │  │
│  │ ☐ 小叶紫檀手串    [未验证]   │  │
│  │ ☑ 金丝楠手串      [已验证] ✓ │  │
│  │ ...                           │  │
│  └───────────────────────────────┘  │
│                                      │
│  [批量标记为已验证] [导出已验证]     │
└─────────────────────────────────────┘
```

---

## 🔧 技术实现要点

### 1. Excel 解析
- 使用 `xlsx` 库（SheetJS）解析 Excel 文件
- 支持 `.xlsx` 和 `.xls` 格式
- 处理大文件（分块读取，避免内存溢出）

### 2. 字段识别算法
```typescript
function detectHeaderRow(rows: string[][], maxScanRows = 10): number {
  // 扫描前 maxScanRows 行
  for (let i = 0; i < Math.min(maxScanRows, rows.length); i++) {
    const row = rows[i]
    // 检查是否包含常见字段关键词
    if (row.some(cell => 
      ['关键词', '词', '名称', '标题'].some(keyword => 
        String(cell).includes(keyword)
      )
    )) {
      return i
    }
  }
  return 0  // 默认第一行
}
```

### 3. 筛选规则实现

#### 规则2：后缀提取算法
```typescript
function extractSuffixMatch(text: string, keyword: string): string | null {
  if (!text.endsWith(keyword)) return null
  
  // 找到关键词在文本中的位置
  const keywordIndex = text.lastIndexOf(keyword)
  if (keywordIndex === -1) return null
  
  // 提取从开头到关键词结束的部分
  return text.substring(0, keywordIndex + keyword.length)
}

// 示例：
// extractSuffixMatch("黄花梨手串价格", "手串") → "黄花梨手串"
// extractSuffixMatch("沉香手串", "手串") → "沉香手串"
```

#### 规则3：前缀提取算法
```typescript
function extractPrefixMatch(text: string, keyword: string): string | null {
  if (!text.startsWith(keyword)) return null
  
  // 可以提取到第一个分隔符，或整个文本
  // 简单实现：提取整个文本（如果以关键词开头）
  return text
  
  // 或者提取到第一个分隔符（如空格、标点）
  // const separators = [' ', '，', '。', '、', '-', '_']
  // const firstSeparatorIndex = text.split('').findIndex(char => separators.includes(char))
  // return firstSeparatorIndex > 0 ? text.substring(0, firstSeparatorIndex) : text
}
```

### 4. 数据存储
- 筛选结果可以临时存储在内存或 IndexedDB
- 导入到手动筛选页面时，可以存储到数据库或本地存储
- 考虑创建新的数据表存储筛选任务和结果

---

## 📊 数据模型（建议）

### 筛选任务表（filter_tasks）
```sql
CREATE TABLE filter_tasks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id),
  file_name TEXT,
  header_row_index INT,
  selected_columns JSONB,  -- 选中的列名数组
  keyword TEXT,
  filter_rule TEXT,  -- 'contains' | 'suffix' | 'prefix'
  total_rows INT,
  filtered_count INT,
  deduplicated_count INT,
  created_at TIMESTAMP DEFAULT NOW(),
  status TEXT DEFAULT 'pending'  -- 'pending' | 'completed' | 'imported'
);
```

### 筛选结果表（filter_results）
```sql
CREATE TABLE filter_results (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  task_id UUID REFERENCES filter_tasks(id),
  keyword_text TEXT,
  source_column TEXT,
  source_row_index INT,
  is_verified BOOLEAN DEFAULT FALSE,
  verified_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ✅ 验收标准

1. **字段识别准确性**：能正确识别 90%+ 的 Excel 文件表头行
2. **筛选规则准确性**：
   - 包含规则：100% 准确匹配
   - 后缀规则：正确提取以关键词结尾的片段
   - 前缀规则：正确提取以关键词开头的片段
3. **性能**：处理 10,000 行数据，筛选时间 < 5 秒
4. **用户体验**：操作流程顺畅，错误提示清晰
5. **数据完整性**：筛选结果不丢失数据，去重准确

---

## 🔗 相关文档

- [导入后自动粗清洗优化方案](./导入后自动粗清洗优化方案.md)
- [长尾词筛选功能优化建议](./长尾词筛选功能优化建议.md)

---

**文档版本**: 1.0  
**创建日期**: 2025-01-03  
**维护者**: NicheMiner 开发团队


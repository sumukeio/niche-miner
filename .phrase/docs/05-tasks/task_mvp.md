# NicheMiner 优化任务清单 (MVP)

> 基于《长尾词筛选功能优化建议》拆解的具体开发任务

---

## 📋 任务总览

| 阶段 | 任务数 | 预计工时 | 优先级 |
|------|--------|----------|--------|
| 第一阶段：性能优化 | 5 | 5-7天 | 🔴 高 |
| 第二阶段：功能增强 | 6 | 7-10天 | 🟡 中 |
| 第三阶段：智能优化 | 4 | 5-7天 | 🟢 低 |
| **总计** | **15** | **17-24天** | - |

---

## 🔴 第一阶段：性能优化（高优先级）

### Task 1: 实现 Web Worker 分词处理
- **任务ID**: PERF-001
- **优先级**: P0
- **预估工时**: 1-2天
- **依赖**: 无

**描述**:
将分词处理从主线程迁移到 Web Worker，解决 UI 阻塞问题。

**技术要点**:
- 创建 `src/app/workers/segmentWorker.ts` Web Worker 文件
- 在主组件中通过 `new Worker()` 初始化 Worker
- 使用 `postMessage` 传递样本数据，接收分词结果
- 处理 Worker 错误和加载状态

**验收标准**:
- ✅ 处理 5000 条关键词时 UI 保持流畅，不卡顿
- ✅ 显示分词处理进度条（0-100%）
- ✅ 处理过程中可以正常操作其他 UI 元素
- ✅ Worker 加载失败时有降级方案（fallback 到主线程）

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/workers/segmentWorker.ts` (新建)

---

### Task 2: 分词结果缓存到 IndexedDB
- **任务ID**: PERF-002
- **优先级**: P1
- **预估工时**: 1天
- **依赖**: PERF-001

**描述**:
将分词结果缓存到客户端 IndexedDB，避免重复计算。

**技术要点**:
- 引入 `localForage` 或 `Dexie.js` 库
- 设计缓存键：`segments_${projectId}_${sampleHash}`
- 实现缓存读写逻辑（先读缓存，命中则跳过分词）
- 添加缓存失效策略（数据更新时清除）

**验收标准**:
- ✅ 刷新页面后，相同样本的分词结果从缓存读取
- ✅ 缓存命中时，分词时间减少 90%+
- ✅ 项目数据更新时，缓存正确失效
- ✅ 缓存大小可控，不影响浏览器性能

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/utils/cache.ts` (新建，可选)

---

### Task 3: 优化数据库随机采样查询
- **任务ID**: PERF-003
- **优先级**: P0
- **预估工时**: 1天
- **依赖**: 无

**描述**:
使用 PostgreSQL 的 `ORDER BY RANDOM()` 或游标分页替代前端随机 offset，提升查询性能。

**技术要点**:
- 在 Supabase 创建 RPC 函数 `get_random_keywords`
- SQL 实现：`SELECT * FROM keywords WHERE project_id = $1 AND status = 'pending' ORDER BY RANDOM() LIMIT 5000;`
- 前端调用 RPC 替代现有的 `.range()` 查询
- 考虑添加数据库索引（见 Task 5）

**验收标准**:
- ✅ 采样查询时间从 5-10s 降低到 < 1s
- ✅ 支持 10万+ 关键词项目的快速采样
- ✅ 返回结果随机性良好，无明显重复

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- Supabase SQL 迁移文件 (新建 RPC)

---

### Task 4: 实现增量分词处理
- **任务ID**: PERF-004
- **优先级**: P1
- **预估工时**: 1天
- **依赖**: PERF-001

**描述**:
不一次性处理 5000 条，而是分批处理（如每批 500 条），提升用户体验。

**技术要点**:
- 实现 `processInBatches(samples, batchSize = 500)` 函数
- 每处理一批，更新进度条 UI
- 使用 `requestIdleCallback` 或 `setTimeout` 控制处理节奏
- 允许用户中断处理过程

**验收标准**:
- ✅ 进度条实时更新，显示 "已处理 X/5000"
- ✅ 处理过程中可以随时点击"刷新"重新采样
- ✅ 分批处理不影响最终结果准确性

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/workers/segmentWorker.ts` (修改)

---

### Task 5: 添加数据库索引优化查询
- **任务ID**: PERF-005
- **优先级**: P0
- **预估工时**: 0.5天
- **依赖**: 无

**描述**:
为常用查询字段添加数据库索引，提升查询性能。

**技术要点**:
- 创建复合索引：`(project_id, status)`
- 创建全文搜索索引：`term gin_trgm_ops`（需启用 pg_trgm 扩展）
- 创建流量排序索引：`search_volume DESC`
- 验证索引使用情况（EXPLAIN ANALYZE）

**验收标准**:
- ✅ 关键词查询速度提升 3-5 倍
- ✅ 全文搜索（LIKE '%keyword%'）性能显著改善
- ✅ 索引不影响写入性能（INSERT/UPDATE）

**相关文件**:
- Supabase SQL 迁移文件 (新建)

---

## 🟡 第二阶段：功能增强（中优先级）

### Task 6: 添加关键词搜索和过滤功能
- **任务ID**: FEAT-001
- **优先级**: P1
- **预估工时**: 1-2天
- **依赖**: 无

**描述**:
在特征词列表顶部添加搜索框，支持按特征词名称、出现次数实时过滤。

**技术要点**:
- 添加搜索框 UI 组件
- 实现实时过滤逻辑：`groups.filter(item => item.word.includes(query) || item.count.toString().includes(query))`
- 支持模糊搜索和数字搜索
- 高亮显示匹配结果

**验收标准**:
- ✅ 输入关键词后，列表实时过滤（无需点击按钮）
- ✅ 支持中文、数字搜索
- ✅ 空搜索时显示全部结果
- ✅ UI 美观，搜索框位置合理

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)

---

### Task 7: 实现关键词预览功能
- **任务ID**: FEAT-002
- **优先级**: P1
- **预估工时**: 2天
- **依赖**: 无

**描述**:
点击特征词卡片，弹出预览窗口，显示包含该词的关键词列表。

**技术要点**:
- 创建预览弹窗组件（Modal/Dialog）
- 实现数据库查询：`.ilike('term', '%${token}%')`
- 显示关键词信息：词条、流量、竞争度
- 支持在预览窗口中直接标记（保留/垃圾）

**验收标准**:
- ✅ 点击特征词卡片，弹出预览窗口
- ✅ 预览窗口显示最多 20 条包含该词的关键词
- ✅ 每条关键词显示：词条、搜索量、竞争度
- ✅ 可以在预览窗口中进行标记操作

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/components/KeywordPreview.tsx` (新建)

---

### Task 8: 实现批量操作功能
- **任务ID**: FEAT-003
- **优先级**: P1
- **预估工时**: 2天
- **依赖**: 无

**描述**:
支持多选特征词，批量标记为"保留"或"垃圾"。

**技术要点**:
- 添加"多选模式"开关
- 每个特征词卡片添加复选框
- 实现多选状态管理：`selectedTokens: Set<string>`
- 实现批量操作：`handleBatchKeep` / `handleBatchBan`
- 添加全选快捷键（Ctrl+A）

**验收标准**:
- ✅ 开启多选模式后，每个卡片显示复选框
- ✅ 可以选择多个特征词
- ✅ 底部显示"已选择 X 个"
- ✅ 批量操作按钮可一次性标记所有选中项
- ✅ 支持 Ctrl+A 全选

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)

---

### Task 9: 添加智能排序和分组功能
- **任务ID**: FEAT-004
- **优先级**: P2
- **预估工时**: 1-2天
- **依赖**: 无

**描述**:
提供多种排序选项（按出现次数、词长度、字母顺序）和分组选项（按长度、商业意图）。

**技术要点**:
- 添加排序下拉菜单：`count | length | alphabetical`
- 实现排序逻辑函数
- 添加分组选项（可选）
- 保存用户排序偏好到 localStorage

**验收标准**:
- ✅ 提供 3 种排序方式：出现次数、词长度、字母顺序
- ✅ 排序切换后，列表立即更新
- ✅ 排序偏好保存，下次打开页面记住选择

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)

---

### Task 10: 实现操作历史记录和撤销功能
- **任务ID**: FEAT-005
- **优先级**: P2
- **预估工时**: 2天
- **依赖**: 无

**描述**:
记录用户操作历史，支持撤销最近一次操作。

**技术要点**:
- 定义操作历史数据结构：`OperationHistory { token, action, timestamp, affectedCount }`
- 实现操作历史栈：`history: OperationHistory[]`
- 实现撤销逻辑：回滚最近一次 RPC 调用
- 添加撤销按钮和历史记录面板

**验收标准**:
- ✅ 每次操作后，记录到历史列表
- ✅ 显示历史记录：时间、操作类型、影响数量
- ✅ 支持撤销最近一次操作
- ✅ 撤销后，关键词状态正确恢复

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/components/OperationHistory.tsx` (新建，可选)

---

### Task 11: 优化操作反馈和实时统计
- **任务ID**: FEAT-006
- **优先级**: P1
- **预估工时**: 1-2天
- **依赖**: 无

**描述**:
优化操作后的用户反馈，添加 Toast 提示和实时统计更新。

**技术要点**:
- 集成 toast 库（如 `react-hot-toast` 或 `sonner`）
- 操作成功后显示 Toast：`已标记 X 个关键词为有效`
- 实现实时统计更新（可选：使用 Supabase Realtime）
- 添加操作进度指示器（处理中/成功/失败）

**验收标准**:
- ✅ 每次操作后显示 Toast 提示
- ✅ 操作进行中显示加载状态
- ✅ 统计数字（待处理/已保留/已删除）实时更新
- ✅ 错误时显示错误提示

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)

---

## 🟢 第三阶段：智能优化（低优先级）

### Task 12: 实现 TF-IDF 加权算法
- **任务ID**: AI-001
- **优先级**: P2
- **预估工时**: 2天
- **依赖**: PERF-001

**描述**:
使用 TF-IDF 算法对特征词进行加权，优化特征词排序。

**技术要点**:
- 实现 TF-IDF 计算函数
- TF：词频 = 出现次数 / 总样本数
- IDF：逆文档频率 = log(总样本数 / 包含该词的关键词数)
- 综合评分 = TF * IDF
- 按 TF-IDF 值排序特征词列表

**验收标准**:
- ✅ 特征词按 TF-IDF 值排序（替代简单词频排序）
- ✅ 高 TF-IDF 值的词排在前面
- ✅ 计算结果准确（可对比手动计算）

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/utils/tfidf.ts` (新建)

---

### Task 13: 实现商业意图评分
- **任务ID**: AI-002
- **优先级**: P2
- **预估工时**: 1天
- **依赖**: AI-001

**描述**:
结合商业意图词典（如"批发"、"价格"、"多少钱"），对特征词进行商业意图加权。

**技术要点**:
- 定义商业意图词典：`commercialIntentWords: string[]`
- 实现意图评分函数：包含商业词的权重 1.5，普通词 1.0
- 综合评分 = TF-IDF * 意图权重
- 允许用户自定义商业意图词典

**验收标准**:
- ✅ 包含商业意图词的特征词排名提升
- ✅ 商业意图词典可配置（localStorage 或数据库）
- ✅ 综合评分公式正确

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/utils/commercialIntent.ts` (新建)

---

### Task 14: 实现智能采样策略
- **任务ID**: AI-003
- **优先级**: P2
- **预估工时**: 2-3天
- **依赖**: PERF-003

**描述**:
实现分层采样，优先采样"模糊地带"的关键词（中等流量、中等竞争度）。

**技术要点**:
- 实现分层采样算法：按流量分三层（高/中/低）
- 每层采样比例：30% / 50% / 20%
- 记录已采样关键词 ID，避免重复采样
- 可选：智能采样（优先采样模糊地带）

**验收标准**:
- ✅ 分层采样覆盖不同质量的关键词
- ✅ 避免重复采样相同关键词
- ✅ 采样结果更具代表性

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- Supabase SQL (RPC 函数修改)

---

### Task 15: 实现动态停用词学习
- **任务ID**: AI-004
- **优先级**: P3
- **预估工时**: 1天
- **依赖**: 无

**描述**:
用户频繁标记为"垃圾"的词，自动加入停用词列表，后续自动过滤。

**技术要点**:
- 记录每个词的"垃圾"标记次数
- 当标记次数 > 3 时，自动加入停用词列表
- 停用词列表存储到 localStorage 或数据库
- 下次分词时自动过滤停用词

**验收标准**:
- ✅ 用户标记 3 次以上"垃圾"的词，自动加入停用词
- ✅ 停用词列表持久化存储
- ✅ 下次刷新时，停用词自动过滤，不显示在列表中

**相关文件**:
- `src/app/components/StepRules.tsx` (修改)
- `src/app/utils/stopWords.ts` (修改)

---

## 📊 任务依赖关系图

```
PERF-001 (Web Worker)
  ├── PERF-002 (缓存)
  └── PERF-004 (增量处理)

PERF-003 (采样优化)
  └── AI-003 (智能采样)

PERF-005 (索引) [独立]

FEAT-001 ~ FEAT-006 [独立，可并行]

AI-001 (TF-IDF)
  └── AI-002 (商业意图)

AI-004 (停用词) [独立]
```

---

## 🎯 实施建议

### 第一周
1. ✅ PERF-001: Web Worker 分词（解决 UI 阻塞）
2. ✅ PERF-003: 优化采样查询（提升性能）
3. ✅ PERF-005: 添加数据库索引（基础优化）
4. ✅ FEAT-001: 添加搜索功能（快速提升体验）

### 第二周
5. ✅ PERF-002: 分词缓存
6. ✅ PERF-004: 增量处理
7. ✅ FEAT-002: 关键词预览
8. ✅ FEAT-006: 操作反馈优化

### 第三周
9. ✅ FEAT-003: 批量操作
10. ✅ FEAT-004: 排序分组
11. ✅ FEAT-005: 操作历史

### 第四周（可选）
12. ✅ AI-001: TF-IDF 算法
13. ✅ AI-002: 商业意图评分
14. ✅ AI-003: 智能采样
15. ✅ AI-004: 动态停用词

---

## 📝 任务状态跟踪

| 任务ID | 任务名称 | 优先级 | 状态 | 开始时间 | 完成时间 | 备注 |
|--------|----------|--------|------|----------|----------|------|
| PERF-001 | Web Worker 分词 | P0 | ⬜ 待开始 | - | - | - |
| PERF-002 | 分词结果缓存 | P1 | ⬜ 待开始 | - | - | - |
| PERF-003 | 优化采样查询 | P0 | ⬜ 待开始 | - | - | - |
| PERF-004 | 增量分词处理 | P1 | ⬜ 待开始 | - | - | - |
| PERF-005 | 数据库索引 | P0 | ⬜ 待开始 | - | - | - |
| FEAT-001 | 搜索过滤功能 | P1 | ⬜ 待开始 | - | - | - |
| FEAT-002 | 关键词预览 | P1 | ⬜ 待开始 | - | - | - |
| FEAT-003 | 批量操作 | P1 | ⬜ 待开始 | - | - | - |
| FEAT-004 | 排序分组 | P2 | ⬜ 待开始 | - | - | - |
| FEAT-005 | 操作历史 | P2 | ⬜ 待开始 | - | - | - |
| FEAT-006 | 操作反馈 | P1 | ⬜ 待开始 | - | - | - |
| AI-001 | TF-IDF 算法 | P2 | ⬜ 待开始 | - | - | - |
| AI-002 | 商业意图评分 | P2 | ⬜ 待开始 | - | - | - |
| AI-003 | 智能采样 | P2 | ⬜ 待开始 | - | - | - |
| AI-004 | 动态停用词 | P3 | ⬜ 待开始 | - | - | - |

**图例**:
- ⬜ 待开始
- 🟡 进行中
- ✅ 已完成
- ❌ 已取消

---

## 🔧 技术栈补充

### 需要安装的新依赖

```bash
# Web Worker 和缓存
npm install localforage  # 或 dexie (IndexedDB 封装)

# UI 组件
npm install react-hot-toast  # 或 sonner (Toast 提示)
npm install @radix-ui/react-dialog  # 或 headlessui (弹窗组件)

# 可选
npm install react-wordcloud  # 词云可视化（低优先级）
```

---

**文档版本**: 1.0  
**创建日期**: 2024-12-24  
**最后更新**: 2024-12-24  
**维护者**: NicheMiner 开发团队


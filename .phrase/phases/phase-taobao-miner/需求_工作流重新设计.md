# 需求文档：NicheMiner 工作流重新设计

## 📋 问题背景

当前 NicheMiner 系统存在以下问题：

1. **功能分散**：工作台上有三个独立的入口（创建项目、淘宝挖掘、广告验证工具），但它们在逻辑上是连续的流程
2. **用户体验不佳**：用户需要在不同页面间跳转，不清楚整个工作流的全貌
3. **概念混淆**：广告验证被当作独立工具，实际上是工作流的最后一步

## 🎯 核心洞察

**NicheMiner 的本质是一个完整的选品工作流，而不是三个独立工具。**

### 完整工作流应该是：

```
┌─────────────────────────────────────────────────────────┐
│                  第一步：数据获取                        │
│  ┌────────────────────┐      ┌────────────────────┐    │
│  │  方式1: 导入5118   │      │  方式2: 淘宝挖掘   │    │
│  │  长尾词表格        │      │  种子词挖掘        │    │
│  └────────┬───────────┘      └────────┬───────────┘    │
│           └────────────┬───────────────┘                │
│                        ▼                                │
│             存入数据库 (status='pending')               │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  第二步：数据清洗                        │
│  - 智能分词分析                                          │
│  - 特征词提取                                            │
│  - 人工筛选判断（是产品/垃圾）                           │
│  - 级联更新状态 (pending → valid/trash)                 │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  第三步：选品看板                        │
│  - 蓝海评分算法                                          │
│  - Top 100 榜单                                          │
│  - 数据可视化                                            │
│  - 导出 CSV                                              │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  第四步：广告验证                        │
│  - 对 valid 状态的关键词进行百度广告验证                 │
│  - 验证商业价值（是否有同行投放广告）                    │
│  - 生成验证报告                                          │
└─────────────────────────────────────────────────────────┘
```

## 📐 设计方案

### 1. 工作台（Dashboard）重新设计

**当前状态**：三个独立入口
- 上传文件创建项目
- 淘宝挖掘工具
- 广告验证工具

**改进方案**：统一为项目工作流入口

```
工作台页面
├── 项目列表（显示所有项目及其进度）
│   ├── 项目卡片显示：
│   │   ├── 项目名称
│   │   ├── 创建时间
│   │   ├── 关键词数量
│   │   ├── 工作流进度（步骤 0/1/2/3）
│   │   └── 当前状态（如：待清洗、待验证等）
│   └── 点击项目卡片 → 进入项目工作流页面
│
└── 创建新项目按钮
    ├── 点击后弹出模态框
    ├── 选择数据获取方式：
    │   ├── 方式1：上传5118表格
    │   └── 方式2：淘宝挖掘
    └── 根据选择进入对应流程
```

### 2. 项目工作流页面（Project Workflow）重新设计

**URL**: `/project/[id]/workflow`

**功能**：统一的项目工作流管理页面

#### 2.1 页面布局

```
┌────────────────────────────────────────────────────┐
│  项目名称: [项目名称]                               │
│  返回工作台                                         │
├────────────────────────────────────────────────────┤
│  工作流进度条（可视化显示当前步骤）                 │
│  [Step 0]─[Step 1]─[Step 2]─[Step 3]              │
│  数据获取  数据清洗  选品看板  广告验证            │
│       ✅       ✅       ⏳       ⬜              │
├────────────────────────────────────────────────────┤
│                                                    │
│  当前步骤内容区域（根据步骤动态加载）              │
│                                                    │
│  Step 0: 数据获取                                  │
│  ├── 如果已导入：显示导入结果统计                  │
│  └── 如果未导入：显示数据获取选项                  │
│      ├── 导入5118表格（现有功能）                  │
│      └── 淘宝挖掘（新功能）                        │
│                                                    │
│  Step 1: 数据清洗（现有StepRules组件）             │
│                                                    │
│  Step 2: 选品看板（现有StepDashboard组件）         │
│                                                    │
│  Step 3: 广告验证                                  │
│  ├── 选择要验证的关键词（默认：所有valid状态）     │
│  ├── 选择验证模式（PC/移动端）                     │
│  ├── 开始验证按钮                                  │
│  └── 显示验证结果                                  │
│                                                    │
└────────────────────────────────────────────────────┘
```

#### 2.2 步骤判断逻辑

```typescript
// 自动判断项目当前应该显示哪个步骤
function getCurrentStep(project: Project): number {
  // Step 0: 数据获取
  // 如果没有任何关键词，显示 Step 0
  if (keywordsCount === 0) return 0
  
  // Step 1: 数据清洗
  // 如果还有 pending 状态的关键词，显示 Step 1
  if (pendingCount > 0) return 1
  
  // Step 2: 选品看板
  // 如果有 valid 关键词但未验证广告，显示 Step 2
  if (validCount > 0 && !hasValidatedAds) return 2
  
  // Step 3: 广告验证
  // 如果已有 valid 关键词，可以进入 Step 3
  if (validCount > 0) return 3
  
  return 0
}
```

### 3. 步骤详细设计

#### Step 0: 数据获取

**功能**：提供两种数据获取方式

**方式1：导入5118表格**（现有功能，保持不变）
- 上传 CSV/XLSX/XLS 文件
- 解析并入库
- 完成后自动进入 Step 1

**方式2：淘宝挖掘**（新功能集成）
- 输入种子词列表
- 配置销量范围
- 开始挖掘
- 实时显示挖掘进度
- 完成后自动进入 Step 1

**UI设计**：
```tsx
<StepDataAcquisition>
  {hasKeywords ? (
    <DataSummary>
      <StatCard>总关键词数: {total}</StatCard>
      <StatCard>来源: {source === 'upload' ? '5118表格' : '淘宝挖掘'}</StatCard>
      <Button>重新获取数据</Button>
    </DataSummary>
  ) : (
    <DataAcquisitionOptions>
      <Tab>导入5118表格</Tab>
      <Tab>淘宝挖掘</Tab>
      {/* 根据Tab显示对应组件 */}
    </DataAcquisitionOptions>
  )}
</StepDataAcquisition>
```

#### Step 1: 数据清洗

**保持不变**：使用现有的 `StepRules` 组件

**改进**：
- 在顶部显示当前步骤提示
- 完成后显示"进入下一步"按钮（可选）

#### Step 2: 选品看板

**保持不变**：使用现有的 `StepDashboard` 组件

**改进**：
- 在顶部显示当前步骤提示
- 增加"下一步：广告验证"按钮（跳转到 Step 3）

#### Step 3: 广告验证（新整合）

**功能**：
- 显示待验证的关键词数量（valid 状态）
- 选择验证模式（PC/移动端）
- 开始验证按钮
- 实时显示验证进度和日志
- 验证结果展示

**UI设计**：
```tsx
<StepAdValidation>
  <ValidationSummary>
    <StatCard>待验证关键词: {validKeywordsCount}</StatCard>
    <StatCard>已验证关键词: {validatedCount}</StatCard>
  </ValidationSummary>
  
  <ValidationConfig>
    <RadioGroup>验证模式: PC / 移动端</RadioGroup>
    <Button onClick={startValidation}>开始验证</Button>
  </ValidationConfig>
  
  {isValidating && (
    <ValidationProgress>
      <LogConsole logs={logs} />
      <ProgressBar current={current} total={total} />
    </ValidationProgress>
  )}
  
  {validationResults && (
    <ValidationResults>
      <ResultTable data={results} />
      <ExportButton>导出验证报告</ExportButton>
    </ValidationResults>
  )}
</StepAdValidation>
```

### 4. 数据流转

```
数据获取 (Step 0)
  ↓
关键词表 (status='pending', source='upload'|'taobao')
  ↓
数据清洗 (Step 1)
  ↓
关键词表 (status='valid'|'trash')
  ↓
选品看板 (Step 2)
  ↓
查看 Top 100 (status='valid')
  ↓
广告验证 (Step 3)
  ↓
验证结果表（新增表或扩展 keywords 表）
  ↓
最终报告
```

### 5. 数据库扩展（可选）

考虑是否需要新增 `ad_validation_results` 表：

```sql
CREATE TABLE ad_validation_results (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  keyword_id UUID REFERENCES keywords(id),
  project_id UUID REFERENCES projects(id),
  has_ads BOOLEAN NOT NULL,
  validated_at TIMESTAMP DEFAULT NOW(),
  mode TEXT, -- 'pc' | 'mobile'
  ad_titles TEXT[],
  ad_links TEXT[],
  screenshots TEXT[]
);
```

或者扩展现有的 `keywords` 表：
```sql
ALTER TABLE keywords
ADD COLUMN has_ads BOOLEAN,
ADD COLUMN ad_validation_date TIMESTAMP,
ADD COLUMN ad_validation_mode TEXT;
```

## 🎨 UI/UX 改进

### 1. 工作流进度条

使用清晰的步骤指示器，显示：
- ✅ 已完成步骤（绿色）
- ⏳ 当前步骤（蓝色，闪烁动画）
- ⬜ 未完成步骤（灰色）

### 2. 步骤切换

- 支持手动切换步骤（如果已完成）
- 自动跳转到下一步（完成任务后）
- 提示用户当前应该做什么

### 3. 状态提示

在每个步骤显示：
- 当前进度统计
- 完成提示（如：已清洗 80% 的关键词）
- 下一步操作提示

## 📋 实施计划

### Phase 1: 工作流页面重构
1. ✅ 创建 `/project/[id]/workflow` 页面
2. ✅ 实现步骤判断逻辑
3. ✅ 实现步骤切换组件
4. ✅ 整合 Step 0（数据获取）

### Phase 2: 淘宝挖掘集成
1. ✅ 将淘宝挖掘集成到 Step 0
2. ✅ 实现数据获取方式切换（Tab）
3. ✅ 统一数据获取后的流程

### Phase 3: 广告验证集成
1. ✅ 创建 Step 3 组件
2. ✅ 整合百度广告验证功能
3. ✅ 实现验证结果展示

### Phase 4: 工作台改进
1. ✅ 重新设计工作台页面
2. ✅ 显示项目进度
3. ✅ 优化创建项目流程

## 🔄 迁移策略

**向后兼容**：
- 保留现有的 `/project/[id]` 页面（旧的三步流程）
- 新增 `/project/[id]/workflow` 页面（新的工作流）
- 逐步迁移用户到新页面

**数据兼容**：
- 现有的项目和关键词数据无需修改
- 新工作流兼容现有数据结构

## 📝 相关文件变更

### 新增文件
- `src/app/project/[id]/workflow/page.tsx` - 工作流页面
- `src/app/components/StepDataAcquisition.tsx` - 数据获取步骤组件
- `src/app/components/StepAdValidation.tsx` - 广告验证步骤组件
- `src/app/components/WorkflowProgress.tsx` - 工作流进度条组件

### 修改文件
- `src/app/dashboard/page.tsx` - 重新设计工作台
- `src/app/components/StepRules.tsx` - 添加步骤上下文
- `src/app/components/StepDashboard.tsx` - 添加步骤上下文

### API 调整
- `src/app/api/taobao-miner/start/route.ts` - 支持从项目ID获取关键词验证
- `src/app/api/baidu-validator/route.ts` - 支持从项目ID读取关键词进行验证

## ✅ 验收标准

1. **工作流完整性**
   - [ ] 用户可以完整地走完四个步骤
   - [ ] 步骤之间可以自然流转
   - [ ] 每个步骤的状态清晰可见

2. **数据获取灵活性**
   - [ ] 支持两种数据获取方式
   - [ ] 两种方式的结果都能进入清洗流程
   - [ ] 数据来源标识清晰（source 字段）

3. **广告验证集成**
   - [ ] 可以直接从项目工作流启动广告验证
   - [ ] 验证结果可以关联到项目
   - [ ] 验证后可以查看详细报告

4. **用户体验**
   - [ ] 用户理解整个工作流
   - [ ] 不需要在多个页面间跳转
   - [ ] 进度和状态一目了然

---

**文档版本**: 1.0  
**创建日期**: 2025-01-03  
**状态**: 📋 需求确认中



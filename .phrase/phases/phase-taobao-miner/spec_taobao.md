# Spec: Taobao Keyword Miner Integration

## 1. Summary
在现有 NicheMiner 系统中增加“淘宝挖掘”数据源模块。
通过 Python 脚本模拟用户搜索淘宝，根据种子词（如“野生”、“教程”）抓取符合销量范围的长尾商品标题，并将其清洗为关键词存入数据库，供后续百度验证。

## 2. Goals
- **独立模块**：开发独立的 `taobao_miner.py` 脚本，不耦合现有业务逻辑。
- **持久化登录**：支持“扫码登录一次，保存 Session/Cookies 长期使用”的机制，绕过淘宝强制登录墙。
- **多账号管理**：支持多个淘宝账号的切换和管理，包括账号列表、切换账号、重新登录等功能。
- **数据清洗**：自动剔除销量过低（<50）或过高（>5000）的红海/死海商品。
- **商品筛选**：支持灵活的筛选条件（价格区间、关键词匹配/排除、店铺类型等）。
- **错误容错**：完善的错误处理和容错机制，包括验证码处理、售罄商品处理、网络异常重试等。
- **无缝集成**：抓取结果直接写入 Supabase `keywords` 表，`source` 标记为 `taobao`。

## 3. User Flows

### Flow 1: 初始化与登录 (Setup)
1. 用户在前端或命令行触发“淘宝登录”。
2. 系统启动 Playwright (Headless: False)。
3. **多账号支持**：
   - 如果已有账号列表，用户可以选择使用现有账号或添加新账号。
   - 支持账号列表管理：查看、添加、删除、切换账号。
   - 每个账号的 Cookies 独立保存（`auth_taobao_<account_name>.json`）。
4. 用户手动扫码登录淘宝（或使用已保存的 Cookies）。
5. 脚本捕获 Cookies 并保存，如果 Cookies 失效，支持“重新登录”功能。

### Flow 2: 挖掘与入库 (Mining)
1. **输入**：
   - 用户输入种子词列表 (e.g., `["野生", "自制"]`)
   - 销量范围（最小/最大）
   - 筛选条件（可选）：
     - 价格区间（最小价格、最大价格）
     - 关键词匹配（必须包含/不能包含的关键词列表）
     - 店铺类型（C店/天猫/不限）
     - 其他条件（退货宝、运费险等）
2. **账号选择**：选择使用的淘宝账号（如果配置了多账号）。
3. **搜索**：脚本加载对应账号的 Cookies，模拟访问淘宝搜索页。
4. **抓取**：
   - 翻页抓取（默认前 5 页，可配置）。
   - 提取字段：标题、销量、价格、店铺名、详情页链接、商品图片URL。
   - **URL拼接优化**：支持直接生成多页URL，提高抓取效率。
5. **错误处理与容错**：
   - **验证码检测**：检测到滑块验证码时，暂停脚本并提示用户手动处理，等待完成后继续。
   - **售罄商品处理**：识别已售罄商品，标记并跳过。
   - **特殊商品处理**：识别需要选择款式/规格的商品，标记并跳过。
   - **网络异常重试**：遇到网络错误时自动重试（最多3次，指数退避）。
   - **Cookies失效处理**：检测到Cookies失效时，提示用户重新登录。
6. **过滤**：
   - 销量过滤：`Min Sales < 销量 < Max Sales`
   - 价格过滤：如果设置了价格区间，只保留范围内的商品。
   - 关键词过滤：根据用户设置的必须包含/不能包含关键词进行过滤。
   - 店铺类型过滤：排除或只包含特定类型的店铺（可选）。
7. **入库**：
   - 对“标题”进行简单分词或直接作为长尾词。
   - 存入 `keywords` 表。
   - 状态默认为 `pending`。
   - `source` 字段设为 `taobao`。

## 4. Technical Constraints

### 4.1 反爬策略
- **Playwright Stealth**：使用 Playwright 的 stealth 模式，隐藏自动化特征。
- **User-Agent 轮换**：维护 User-Agent 池，随机轮换使用。
- **随机等待**：模拟真人操作，页面间随机等待 2-5 秒。
- **Viewport 模拟**：设置真实的浏览器视口大小（1920x1080）。
- **IP 代理**（可选增强）：
  - 支持配置 IP 代理池，避免单 IP 频繁请求触发风控。
  - 代理失效时自动切换。
- **Cookies 代理池**（可选增强）：
  - 维护多个账号的 Cookies 池，轮换使用降低单账号请求频率。

### 4.2 并发控制
- **单线程抓取**：淘宝风控较严，使用单线程慢速抓取，不使用多线程。
- **请求频率控制**：每个请求之间随机等待，避免过于频繁的请求。

### 4.3 异常处理与容错
- **验证码处理**：
  - 自动检测滑块验证码出现。
  - 暂停脚本，在浏览器中显示验证码，等待用户手动处理。
  - 处理完成后自动继续。
  - 如果 30 秒内未完成，记录日志并跳过当前页面。
- **网络异常**：
  - 自动重试机制（最多 3 次）。
  - 指数退避策略（1秒、2秒、4秒）。
  - 记录详细的错误日志。
- **数据解析失败**：
  - 如果页面结构变化导致解析失败，尝试备用选择器。
  - 记录失败的商品，方便后续人工检查。
- **特殊商品处理**：
  - 自动识别已售罄商品，跳过不处理。
  - 识别需要选择款式/规格的商品，标记为特殊商品。

### 4.4 浏览器管理
- **Playwright 自动管理**：Playwright 自动管理浏览器和驱动，无需手动维护。
- **浏览器版本兼容性**：确保 Playwright Chromium 版本稳定，避免版本不兼容导致的问题。
- **浏览器上下文复用**：在同一个浏览器会话中复用上下文，提高效率。

### 4.5 数据提取优化
- **多种数据源**：
  - 优先从 DOM 元素提取数据。
  - 备用方案：解析页面中的 JavaScript JSON 数据（如果可用）。
- **URL 生成优化**：
  - 支持直接生成多页搜索 URL，避免重复加载页面。
  - 批量处理 URL，提高抓取效率。

## 5. Database Schema Updates
需要更新 `keywords` 表结构（在 `tech-refer.md` 中体现）：
- Add `source`: text (default 'upload', new value 'taobao')
- Add `taobao_sales`: int
- Add `taobao_price`: numeric
- Add `origin_url`: text
- Add `taobao_image_url`: text (商品图片URL，可选)
- Add `taobao_shop_name`: text (店铺名称，可选)
- Add `taobao_shop_type`: text (店铺类型：'c_shop'/'tmall'/'other'，可选)

## 6. 功能增强需求（参考开源项目）

### 6.1 多账号管理
- **账号列表管理**：
  - 支持添加、删除、查看账号列表。
  - 账号信息保存在本地配置文件（`taobao_accounts.json`）或数据库。
  - 每个账号独立保存 Cookies（`auth_taobao_<account_name>.json`）。
- **账号切换**：
  - 在挖掘任务中可以选择使用哪个账号。
  - 支持账号状态检查（Cookies 是否有效）。
- **重新登录**：
  - 检测到账号失效时，提供“重新登录”功能。
  - 重新登录后自动更新 Cookies。

### 6.2 商品筛选条件
- **价格筛选**：
  - 最小价格、最大价格（包含边界值）。
  - 支持开关控制是否启用价格筛选。
- **关键词筛选**：
  - **必须包含**：商品标题必须包含指定关键词（支持多个，AND 关系）。
  - **不能包含**：商品标题不能包含指定关键词（支持多个，OR 关系）。
- **店铺类型筛选**：
  - C店（个人店铺）
  - 天猫店铺
  - 不限
- **其他筛选条件**（可选）：
  - 退货宝
  - 运费险
  - 自定义筛选条件（匹配页面上的文本标签）

### 6.3 错误处理与容错机制
- **验证码处理流程**：
  1. 自动检测验证码元素（`.nc_iconfont`, `.baxia-dialog`, `#nocaptcha` 等）。
  2. 暂停脚本，弹出提示信息。
  3. 在浏览器中显示验证码，等待用户手动处理。
  4. 处理完成后自动继续（检测验证码元素消失）。
  5. 超时处理：如果 30-60 秒内未完成，记录日志并跳过。
- **售罄商品处理**：
  - 检测售罄标识（`.sold-out`, `.no-stock` 等选择器）。
  - 标记为售罄，跳过不处理。
- **特殊商品处理**：
  - 检测需要选择款式/规格的商品（`.style-selector`, `.spec-selector` 等）。
  - 标记为特殊商品，记录日志，跳过处理。
- **网络异常重试**：
  - 检测网络错误（超时、连接失败等）。
  - 自动重试（最多 3 次）。
  - 使用指数退避策略（1秒、2秒、4秒）。
  - 所有重试失败后，记录错误并继续下一个商品/页面。
- **Cookies 失效处理**：
  - 检测到被重定向到登录页时，判断 Cookies 失效。
  - 提示用户重新登录或切换到其他账号。
  - 保存失效记录，避免频繁尝试失效的账号。

### 6.4 数据提取优化
- **多数据源提取**：
  - **DOM 提取**（主要方式）：从页面 DOM 元素中提取商品信息。
  - **JSON 数据提取**（备用方案）：解析页面中的 JavaScript JSON 数据（`window.initialData` 等）。
- **URL 生成优化**：
  - 支持直接生成多页搜索 URL，避免重复加载页面。
  - 例如：`https://s.taobao.com/search?q=关键词&s=0`（第1页），`s=44`（第2页），`s=88`（第3页）等。
- **批量处理**：
  - 支持批量生成 URL 列表。
  - 支持断点续传（记录已处理的页面，失败后可以从断点继续）。

## 7. 参考项目学习总结

### 7.1 taobao-auto-selector (Selenium + PyQt5)
**可借鉴点**：
- 多账号管理机制
- 商品筛选条件的灵活配置
- 错误处理和特殊商品识别
- 用户友好的交互流程

### 7.2 TaoBaoSpider
**可借鉴点**：
- 破解滑块验证码的流程（需要注意浏览器版本兼容性）
- IP 代理和 Cookies 代理池的轮换机制
- 处理 JavaScript JSON 数据的方式
- URL 拼接生成多页 URL 的优化
- 提取商品图片 URL

### 7.3 我们的优势
- ✅ 使用 Playwright（比 Selenium 更现代、性能更好）
- ✅ 数据存储到 Supabase（比本地文件更强大）
- ✅ 实时日志（SSE）
- ✅ 已集成到工作流系统
- ✅ Web 界面（比桌面应用更方便）

### 7.4 待改进项
- ⚠️ 多账号管理（当前单账号已够用，但可以预留接口）
- ⚠️ 商品筛选条件扩展（根据实际需求添加）
- ⚠️ 错误处理细节优化（根据实际使用反馈优化）
- ⚠️ IP 代理支持（如果需要大规模抓取，可以添加）
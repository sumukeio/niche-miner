# 百度反爬机制与解决方案

## 🤔 为什么搜索框不可见？

这是**百度官方的反爬虫措施**。当百度检测到自动化工具访问时，可能会：

1. **隐藏搜索框**：通过 CSS 或 JavaScript 将搜索框设置为不可见
2. **检测自动化特征**：识别 `navigator.webdriver` 等自动化标识
3. **行为分析**：检测鼠标移动轨迹、操作速度等非人类行为模式
4. **IP 频率限制**：如果短时间内大量请求，可能会限制访问

## 🛡️ 我们已经实施的解决方案

### 1. 浏览器配置优化

```python
# 启动参数
args=[
    '--disable-blink-features=AutomationControlled',  # 隐藏自动化特征
    '--disable-dev-shm-usage',
    '--no-sandbox',
    '--disable-setuid-sandbox',
]
```

### 2. JavaScript 注入（隐藏自动化特征）

在页面加载前注入脚本，隐藏常见的自动化标识：

```javascript
// 隐藏 webdriver 特征
Object.defineProperty(navigator, 'webdriver', {
    get: () => undefined
});

// 覆盖 plugins、languages 等
Object.defineProperty(navigator, 'plugins', {
    get: () => [1, 2, 3, 4, 5]
});
```

### 3. 模拟真实用户行为

- **鼠标移动**：在访问页面后移动鼠标到屏幕中心
- **页面点击**：点击页面激活交互
- **滚动操作**：模拟页面滚动
- **延迟输入**：使用 `type()` 方法模拟真实打字速度（50-150ms 延迟）

### 4. 双重策略（主要方案）

**策略1：尝试正常搜索**
- 等待搜索框可见（5秒超时）
- 如果可见，模拟真实用户输入和点击

**策略2：直接 URL 方式（备用方案）**
- 如果搜索框不可见，立即切换到直接 URL 搜索
- 格式：`https://www.baidu.com/s?wd={关键词}`
- **这是最可靠的方案**，不依赖页面交互

## 💡 推荐做法

### 方案A：使用直接 URL 方式（推荐）

最简单可靠的方法是在代码中直接使用 URL 方式。可以修改代码默认使用 URL 方式：

```python
# 在 search_keyword 函数中，直接使用 use_direct_url=True
def search_keyword(self, page: Page, keyword: str, use_direct_url: bool = True):  # 默认为 True
    ...
```

**优点**：
- ✅ 不依赖页面交互，更稳定
- ✅ 速度更快（跳过了页面加载和交互）
- ✅ 不会被反爬机制影响

**缺点**：
- ⚠️ 不如真实用户行为自然（但对于我们的需求足够）

### 方案B：使用真实浏览器（手动操作）

如果自动化工具经常被检测，可以考虑：

1. **使用非无头模式**：`python baidu_ad_validator.py` （不添加 `--headless`）
2. **降低请求频率**：增加等待时间，减少并发
3. **使用代理 IP**：轮换不同的 IP 地址
4. **人工辅助**：少量关键词可以手动验证

### 方案C：增加更多反反爬措施

如果需要进一步提高成功率，可以：

1. **使用真实浏览器指纹**：使用 `playwright-stealth` 等库
2. **模拟更真实的鼠标轨迹**：使用曲线移动而非直线
3. **添加 Cookie**：预先登录百度账号
4. **使用不同的 User-Agent**：轮换不同的浏览器标识

## ⚠️ 注意事项

1. **合法使用**：遵守百度的服务条款，不要过度频繁请求
2. **数据量控制**：建议每次运行不超过 5000 个关键词
3. **频率限制**：每次搜索之间已有 2-5 秒的随机等待
4. **IP 限制**：如果遇到大量失败，可能是 IP 被限制，需要等待一段时间

## 🔧 当前代码的工作流程

```
访问百度首页
  ↓
等待搜索框可见（5秒超时）
  ↓
如果可见
  ├─→ 模拟鼠标移动
  ├─→ 点击搜索框
  ├─→ 模拟打字输入（延迟）
  └─→ 点击搜索按钮
  ↓
如果不可见
  └─→ 立即切换到 URL 方式（https://www.baidu.com/s?wd=关键词）
  ↓
等待搜索结果加载
  ↓
检测广告
```

## 📊 成功率优化建议

1. **优先使用 URL 方式**：最稳定可靠
2. **非无头模式**：在有屏幕的环境中运行，成功率更高
3. **降低频率**：增加搜索间隔时间
4. **分批处理**：将大量关键词分成小批次处理
5. **监控日志**：观察哪些关键词失败，分析原因

## 🚀 快速修复

如果遇到搜索框不可见的问题，最简单的方法是在代码中**默认使用 URL 方式**：

在 `baidu_ad_validator.py` 中，找到 `search_keyword` 函数，将默认参数改为：

```python
def search_keyword(self, page: Page, keyword: str, use_direct_url: bool = True):  # 改为 True
```

这样会默认使用直接 URL 方式，避免所有交互问题。

